#!/usr/bin/env bash

# https://github.com/imapsync/imapsync
#
# gmail:
# https://support.google.com/mail/answer/7126229?hl=en#zippy=%2Cstep-change-smtp-other-settings-in-your-email-client
# https://imapsync.lamiral.info/FAQ.d/FAQ.Gmail.txt
#
# apple:
# https://support.apple.com/en-us/HT202304
# imap.mail.me.com

# pepare
args=()

# host
if confirm-positive --ppid=$$ -- "Is the origin IMAP server hosted by Gmail?"; then
	args+=(
		--host1 imap.gmail.com
		--gmail1
	)
elif confirm-positive --ppid=$$ -- "Is the origin IMAP server hosted by iCloud?"; then
	args+=(
		--host1 imap.mail.me.com
		--ssl1 --port1 993
		--authmech1 LOGIN
	)
else
	args+=(
		--host1 "$(
			ask --required \
				--question="What is the origin IMAP server hostname?"
		)"
	)
	if confirm-positive --ppid=$$ -- "Does the origin server use SSL?"; then
		args+=(--ssl1)
	fi
	args+=(
		--port1 "$(
			ask --required \
				--question="What is the origin IMAP server's port?"
		)"
	)
fi
args+=(
	--user1 "$(
		ask --required \
			--question="What is the origin IMAP server's username?"
	)"
	--password1 "$(
		ask --required \
			--question="What is the origin IMAP server's password?"
	)"
)

# target
if confirm-positive --ppid=$$ -- "Is the target IMAP server hosted by Gmail?"; then
	args+=(
		--host2 imap.gmail.com
		--gmail2
	)
elif confirm-positive --ppid=$$ -- "Is the target IMAP server hosted by iCloud?"; then
	args+=(
		--host2 imap.mail.me.com
		--ssl2 --port1 993
		--authmech2 LOGIN
	)
else
	args+=(
		--host1 "$(
			ask --required \
				--question="What is the target IMAP server's hostname?"
		)"
	)
	if confirm-positive --ppid=$$ -- "Does the target server use SSL?"; then
		args+=(--ssl2)
	fi
	args+=(
		--port2 "$(
			ask --required \
				--question="What is the target IMAP server's port?"
		)"
	)
fi
args+=(
	--user2 "$(
		ask --required \
			--question="What is the target IMAP server's username?"
	)"
	--password2 "$(
		ask --required \
			--question="What is the target IMAP server's password?"
	)"
)

# delete?
if confirm-positive --ppid=$$ -- "Delete messages from the origin IMAP server?"; then
	args+=(--delete1 --expunge1 --noexpungeaftereach)
fi

# act and continue until success
while true; do
	{
		imapsync \
			--automap \
			--skipcrossduplicates \
			--addheader --useheader "Message-Id" \
			--syncinternaldates \
			--nofoldersizes --nofoldersizesatend --no-modulesversion --nolog \
			"${args[@]}" && break
	} || :
done
