#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# =====================================
# Start

echo-segment --h1='Setup Rust'

# =====================================
# Configuration

source "$DOROTHY/sources/config.sh"

# setup.bash provides:
CARGO_INSTALL=()
RUST_INSTALL=() # deprecated, use CARGO_INSTALL
load_dorothy_config 'setup.bash'

# =====================================
# Action

# clean
if is-brew && test -n "$(brew-installed -- rustup rust || :)"; then
	if confirm-positive 'Rust is currently installed via homebrew. Confirm that you want Dorothy to use rustup to manage rust instead. Rustup is the official and only endorsed method of managing rust.'; then
		brew uninstall -f rustup rust
	fi
fi

# dependencies
echo-segment --h2="Install build dependencies"
setup-util-devel
echo-segment --g2="Install build dependencies"

# rustup
echo-segment --h2="Install rustup"
if command-exists rustup; then
	rustup update
else
	# https://rust-lang.github.io/rustup/installation/other.html
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --no-modify-path
fi
echo-segment --g2="Install rustup"

# packages
function install_each_cargo_crate() {
	echo-segment --h2="Install $# rust crates"
	log-performance
	for line in "$@"; do
		env NAME="cargo:$line" CARGO="$line" setup-util cargo
	done
	echo-segment --g2="Install $# rust crates"
}
install_each_cargo_crate "${CARGO_INSTALL[@]}" "${RUST_INSTALL[@]}"

# =====================================
# Finish

echo-segment --g1='Setup Rust'
