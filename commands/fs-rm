#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function fs-rm() (
	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Remove the paths from the file system, with some safety checks in place.

			USAGE:
			fs-size [--] ...<paths>
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # Invalid argument
	}

	# process
	local item paths=()
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--')
			paths+=("$@")
			shift $#
			break
			;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) paths+=("$item") ;;
		esac
	done

	# =====================================
	# Dependencies

	env QUIET=yes setup-util-dust

	# =====================================
	# Action

	local conclusion
	function act {
		local path="$1"
		path="$(fs-absolute "$path")"

		# is the path missing
		if test ! -e "$path"; then
			conclusion="$(
				echo-style --green="was previously removed."
			)"
			return
		fi
		# path exists

		# note its size
		find "$path" -empty -type d -delete || :
		if test ! -e "$path"; then
			conclusion="$(
				echo-style --green="was only empty directories, it has been removed."
			)"
			return
		fi
		# there are leftovers

		# log them
		cat <<-EOF

			$(echo-eval -- ls -la "$path")

			$(echo-eval -- dust --no-percent-bars "$path")

			$(echo-eval -- dust --no-percent-bars --filecount "$path")

		EOF

		# confirm their removal
		if confirm-positive --ppid=$$ -- "$(
			echo-style --notice="Confirm removal of non-empty" --bold=" $path " --notice="?"
		)"; then
			rm -Rfv "$path" || : # may or may not remove
		fi

		# fail if not removed
		if test -e "$path"; then
			conclusion="$(
				echo-style --red="has non-empty files, it has been kept."
			)"
			return 66 # Directory not empty
		fi

		# success if removed
		conclusion="$(
			echo-style --green="had non-empty files, it was manually removed."
		)"
	}

	# act with wrapping of success
	local path title result=0
	for path in "${paths[@]}"; do
		title="fs-rm $(echo-quote "$path")"
		echo-segment --h2="$title"
		if act "$path"; then
			echo-segment --g2="$title" " $conclusion"
		else
			result="$?"
			echo-segment --e2="$title" " $conclusion"
		fi
	done

	return "$result"
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	checksum "$@"
fi
