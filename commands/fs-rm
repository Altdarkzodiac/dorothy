#!/usr/bin/env bash

function fs-rm() (
	source "$DOROTHY/sources/strict.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Remove the paths from the file system, with some safety checks in place.

			USAGE:
			fs-rm [...options] [--] ...<path>

			OPTIONS:
			--sudo
			    If specified, use sudo when removing the files.
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # Invalid argument
	}

	# process
	local item paths=() sudo='no'
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--no-sudo'* | '--sudo'*)
			sudo="$(get-flag-value sudo --missing="$sudo" -- "$item" | echo-affirmative)"
			;;
		'--')
			paths+=("$@")
			shift $#
			break
			;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) paths+=("$item") ;;
		esac
	done

	# check
	if test "${#paths[@]}" -eq 0; then
		help "No <paths> were provided."
	fi

	# =====================================
	# Dependencies

	setup-util-dust --quiet

	# =====================================
	# Action

	local conclusion
	function act {
		local path="$1"
		path="$(fs-absolute -- "$path")"

		# is the path missing
		if test ! -e "$path"; then
			conclusion="$(
				echo-style --green="was previously removed."
			)"
			return 0
		fi
		# path exists

		# note its size
		find "$path" -empty -type d -delete || :
		if test ! -e "$path"; then
			conclusion="$(
				echo-style --green="was only empty directories, it has been removed."
			)"
			return 0
		fi
		# there are leftovers

		# log them
		cat <<-EOF

			$(eval-helper -- ls -la "$path")

			$(eval-helper -- dust --no-percent-bars "$path")

			$(eval-helper -- dust --no-percent-bars --filecount "$path")

		EOF

		# confirm their removal
		if confirm --positive --ppid=$$ -- "$(
			echo-style --notice="Confirm removal of non-empty" --bold=" $path " --notice="?"
		)"; then
			if test "$sudo" = 'yes'; then
				sudo-helper -- rm -rfv "$path" || :
			else
				rm -rfv "$path" || :
			fi
			# || : as we detect successful removal below
		fi

		# fail if not removed
		if test -e "$path"; then
			conclusion="$(
				echo-style --red="has non-empty files, it has been kept."
			)"
			return 66 # Directory not empty
		fi

		# success if removed
		conclusion="$(
			echo-style --green="had non-empty files, it was manually removed."
		)"
	}

	# act with wrapping of success
	local path title result=0
	for path in "${paths[@]}"; do
		title="fs-rm $(echo-quote "$path")"
		echo-segment --h2="$title"
		if act "$path"; then
			echo-segment --g2="$title" " $conclusion"
		else
			result="$?"
			echo-segment --e2="$title" " $conclusion"
		fi
	done

	return "$result"
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	fs-rm "$@"
fi
