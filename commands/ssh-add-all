#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/nullglob.bash"

# create .ssh config file if necessary
mkdir -p "$HOME/.ssh"
if test ! -f "$HOME/.ssh/config"; then
	touch "$HOME/.ssh/config"
fi

# which command
ssh_add_new=()
ssh_add_known=()
if is-mac; then
	if test "$(uname -r | cut -d . -f1)" -ge 21; then
		ssh_add_new=(
			'/usr/bin/ssh-add'
			'--apple-use-keychain'
		)
		ssh_add_known=(
			'/usr/bin/ssh-add'
			'--apple-load-keychain'
		)
	else
		ssh_add_new=(
			'/usr/bin/ssh-add'
			'-K'
		)
		ssh_add_known=(
			'/usr/bin/ssh-add'
			'-A'
		)
	fi
else
	ssh_add_new=(
		'ssh-add'
		'-K'
	)
	ssh_add_known=(
		'ssh-add'
		'-A'
	)
fi

# for found keys, correct permissions, add to keychain, add to agent
find "$HOME/.ssh/"*.pub | while read -r public_key; do
	chmod 600 "$public_key" || :
	private_key="${public_key%.pub}"
	if test -f "$private_key"; then
		chmod 600 "$private_key" || :
		("${ssh_add_new[@]}" "$private_key") || :
	fi
done

# add known keys to keychain and agent
("${ssh_add_known[@]}") || :
