#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# =====================================
# Arguments

# help
function help() {
	cat <<-EOF >/dev/stderr
		ABOUT:
		Get your local or remote IP address.

		USAGE:
		what-is-my-ip [local|remote]
	EOF
	if test "$#" -ne 0; then
		echo-style $'\n' --error="ERROR:" $'\n' --red="$(echo-lines -- "$@")" >/dev/stderr
	fi
	return 22 # Invalid argument
}

# process
what=''
while test "$#" -ne 0; do
	item="$1"
	shift
	case "$item" in
	'local' | 'remote') what="$item" ;;
	'--'*) help "An unrecognised flag was provided: $item" ;;
	*) help "An unrecognised argument was provided: $item" ;;
	esac
done

# ensure
what="$(
	choose-option --required \
		--question='Which IP address do you want?' \
		--filter="$what" -- local remote
)"

# =====================================
# Act

if test "$what" = 'remote'; then
	# does not take into account cloudflare warp
	# fetch https://ipinfo.io/ip

	# does take into account cloudflare warp
	fetch https://whatmyip.bevry.workers.dev
elif command-exists ip; then
	# dependencies
	source "$DOROTHY/sources/ripgrep.bash"

	# cycle through interfaces
	# shellcheck disable=SC2016
	ip -brief address | rg -o 'UP\s+(.+?)[/ ]' --replace '$1'
elif command-exists ifconfig; then
	# dependencies
	source "$DOROTHY/sources/ripgrep.bash"

	# find
	# shellcheck disable=SC2016
	ifconfig | rg -o 'inet ((192\.168\.|10\.0\.)\d+\.\d+)' --replace '$1'
else
	echo-style --error='unsupported environment' >/dev/stderr
	exit 19 # ENODEV 19 Operation not supported by device
fi
