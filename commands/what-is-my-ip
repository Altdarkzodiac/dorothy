#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# =====================================
# Arguments

# help
function help() {
	cat <<-EOF >/dev/stderr
		ABOUT:
		Fetch your IP address.

		USAGE:
		what-is-my-ip [--] ...[local|remote]

		QUIRKS:
		If no [type] is specified, all types will be returned.
	EOF
	if test "$#" -ne 0; then
		echo-style $'\n' --error="ERROR:" $'\n' --red="$(echo-lines -- "$@")" >/dev/stderr
	fi
	return 22 # Invalid argument
}

# process
option_types=()
while test "$#" -ne 0; do
	item="$1"
	shift
	case "$item" in
	'help' | '--help' | '-h') help ;;
	'--')
		option_types+=("$@")
		shift "$#"
		break
		;;
	'--'*) help "An unrecognised flag was provided: $item" ;;
	*) option_types+=("$item") ;;
	esac
done

# ensure types
if test "${#option_types[@]}" -eq 0; then
	option_types=(
		'local'
		'remote'
	)
fi

# =====================================
# Helpers

function get_ip_local {
	if command-exists ip; then
		# dependencies
		source "$DOROTHY/sources/ripgrep.bash"

		# only works on eth0
		# https://stackoverflow.com/a/26694162/130638
		# ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'

		# works on all interfaces
		# shellcheck disable=SC2016
		ip -brief address | rg -o 'UP\s+(.+?)[/ ]' --replace '$1'

	elif command-exists ifconfig; then
		# dependencies
		source "$DOROTHY/sources/ripgrep.bash"

		# fetch all 192.168.x and 10.0.x addresses
		# shellcheck disable=SC2016
		ifconfig | rg -o 'inet ((192\.168\.|10\.0\.)\d+\.\d+)' --replace '$1'
	else
		echo-style --error="$0: Getting the local IP address is unsupported on this platform." >/dev/stderr
		return 19 # ENODEV 19 Operation not supported by device
	fi
}

function get_ip_remote {
	# does not take into account cloudflare warp
	# fetch http://ipecho.net/plain
	# fetch https://ipinfo.io/ip

	# does take into account cloudflare warp
	fetch https://whatmyip.bevry.workers.dev
}

# =====================================
# Act

if test "${#option_types[@]}" -eq 1; then
	"get_ip_${option_types[0]}"
else
	for type in "${option_types[@]}"; do
		printf '%s: ' "${type@u}"
		"get_ip_${type}"
	done
fi
