#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# https://wiki.manjaro.org/index.php/Snap
# https://packages.ubuntu.com/bionic/gnome/gnome-software-plugin-snap

function setup-util-snap() (
	# check for compatibility
	if ! is-linux; then
		echo-style --notice="[$0] is only intended to be run on Linux systems, skipping." >/dev/stderr
		return 0
	fi

	# install snap
	setup-util "$@" NAME='snap' CLI='snap' \
		DNF='snapd' \
		PAMAC='snapd'

	# capture exit from --optional and --confirm, as well as WSL in which snap is busted
	if ! is-snap; then
		return 0
	fi

	# log start
	echo-segment --h2='Configure snap'

	# ensure snap is available to the system
	if test ! -d /snap; then
		sudo ln -s /var/lib/snapd/snap /snap
	fi

	# ensure snap service is running
	if ! systemctl status snapd.socket --no-pager >/dev/null; then
		sudo systemctl enable --now snapd.socket
	fi

	# install snap support for gnome-software (if it exists)
	if command-exists gnome-software; then
		# PAMAC='gnome-software-snap' \
		# Error: target not found: gnome-software-snap
		setup-util "$@" --optional NAME='Snap via Gnome Software' \
			APT='gnome-software-plugin-snap'
	fi

	# log success
	echo-segment --g2='Configure snap'
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-snap "$@"
fi
