#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-snap() (
	# =====================================
	# Checks

	# check that an accident has not occured
	if ! is-linux; then
		echo-style --notice="[$0] is only intended to be run on Linux systems, skipping." >/dev/stderr
		return 0
	fi

	# check applicability
	if test "${ACTION-}" = 'update' && command-missing snap; then
		echo-style --notice="[snap] is missing, and we are [update] only, skipping." >/dev/stderr
		return 0
	fi

	# =====================================
	# Start

	echo-segment --h1='Setup Snap'

	# =====================================
	# Configuration

	source "$DOROTHY/sources/config.bash"

	# setup.bash provides:
	local SNAP_INSTALL=()
	load_dorothy_config 'setup.bash'

	# adjustments
	mapfile -t SNAP_INSTALL < <(prepare_packages 'SNAP_INSTALL' -- "${SNAP_INSTALL[@]}")

	# =====================================
	# Action

	# https://wiki.manjaro.org/index.php/Snap
	# https://packages.ubuntu.com/bionic/gnome/gnome-software-plugin-snap

	setup-util "$@" NAME='snap' CLI='snap' \
		DNF='snapd' \
		PAMAC='snapd'

	if ! systemctl status snapd.socket --no-pager >/dev/null; then
		sudo systemctl enable --now snapd.socket
	fi

	if test ! -d /snap; then
		sudo ln -s /var/lib/snapd/snap /snap
	fi

	if command-exists gnome-software; then
		# PAMAC='gnome-software-snap' \
		# Error: target not found: gnome-software-snap
		setup-util "$@" --optional NAME='Snap via Gnome Software' \
			APT='gnome-software-plugin-snap'
	fi

	# snap update
	sudo snap refresh

	# =====================================
	# Packages

	function snap_install_bulk {
		echo-segment --h2="Install $# snaps"
		if test "$#" -ne 0; then
			setup-util "$@" NAME="snap:$*" SNAP="$*"
		fi
		echo-segment --g2="Install $# snaps"
	}

	snap_install_bulk "${SNAP_INSTALL[@]}"

	# configure with
	# snap list --color=never | sed '1d' | cut -d' ' -f1 | grep --invert-match --extended-regexp --regexp='^(core|snapd)'

	# =====================================
	# Finish

	echo-segment --g1='Setup Snap'
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-snap "$@"
fi
