#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-samba() (
	# =====================================
	# Checks

	# check for support
	if ! is-linux; then
		echo-style --notice="[$0] currently only supports Linux systems, skipping." >/dev/stderr
		return 0
	fi

	# =====================================
	# Action

	# --paths
	local samba_config='/etc/samba/smb.conf'
	local samba_paths=(
		"$samba_config"
		'/etc/samba/'
	)
	if test "${1-}" = '--paths'; then
		echo-lines -- "${samba_paths[@]}"
		return 0
	fi

	# install
	setup-util "$@" NAME='Samba' \
		APT='samba samba-common-bin'
	sudo systemctl disable smbd || :
	sudo systemctl stop smbd || :

	# ensure correct permissions
	sudo mkdir -p /etc/samba/credentials/share
	sudo chown root:root /etc/samba/credentials
	sudo chmod 700 /etc/samba/credentials
	sudo chmod 600 /etc/samba/credentials/share

	# configure
	if confirm-negative --ppid=$$ -- "Customise Samba configuration?"; then
		source "$DOROTHY/sources/edit.sh"
		sudo_edit "$samba_config"
	fi

	# verify configuration
	testparm --suppress-prompt
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-samba "$@"
fi
