#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-samba() (
	# check for support
	if ! is-ubuntu; then
		echo-style --error="[$0] is implemented for Ubuntu systems..." >/dev/stderr
		if ! confirm-negative --ppid=$$ -- 'Proceed at your own risk?'; then
			return 1
		fi
	fi

	# =====================================
	# Action

	# --paths
	local samba_config='/etc/samba/smb.conf'
	local samba_paths=(
		"$samba_config"
		'/etc/samba/'
	)
	if test "${1-}" = '--paths'; then
		echo-lines -- "${samba_paths[@]}"
		return 0
	fi

	# install
	setup-util "$@" --name='Samba' \
		APK='samba' \
		APT='samba' APT='samba-common-bin'
	sudo systemctl disable smbd || :
	sudo systemctl stop smbd || :

	# ensure correct permissions
	sudo mkdir -p /etc/samba/credentials/share
	sudo chown root:root /etc/samba/credentials
	sudo chmod 700 /etc/samba/credentials
	sudo chmod 600 /etc/samba/credentials/share

	# configure
	if confirm-negative --ppid=$$ -- "Customise Samba configuration?"; then
		edit --sudo -- "$samba_config"
	fi

	# verify configuration
	testparm --suppress-prompt
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-samba "$@"
fi
