#!/usr/bin/env bash

function setup-util-samba() (
	source "$DOROTHY/sources/strict.bash"

	# =====================================
	# Arguments

	# help
	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Sets up a plex media server.

			USAGE:
			setup-util-plex [...options]

			OPTIONS:
			--get-config-paths
			    If specified, output configuration paths, useful for restoring backups.

			--get-service-ids
			    If specified, output service identifiers, ordered by startup preference.

			...
			    All other options are forwarded to $(echo-style --code='setup-util').
		EOF
		return 22 # Invalid argument
	}

	# process
	local item action='install' util=()
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--get-config-paths') action='get-config-paths' ;;
		'--get-service-ids') action='get-service-ids' ;;
		'--install') action='install' ;;
		'--uninstall') action='uninstall' ;;
		'--action='*) action="${item#*--action=}" ;;
		*) util+=("$item") ;;
		esac
	done

	# ensure action inside util
	util+=("--action=$action")

	# =====================================
	# Preparation

	local service_title='Samba'
	local service_ids=()
	if is-mac; then
		service_ids+=('system/com.apple.smbd')
	else
		# https://www.samba.org/samba/docs/current/man-html/smbd.8.html
		# https://www.samba.org/samba/docs/current/man-html/nmbd.8.html
		# https://www.samba.org/samba/docs/current/man-html/winbindd.8.html
		# daemons: smbd, nmbd (netbios naming), winbindd (windows nt naming)
		# service names change based on operating system
		if is-ubuntu; then
			service_ids+=('nmbd' 'smbd')
		else
			service_ids+=('nmb' 'smb')
		fi
	fi
	local service_config_file='/etc/samba/smb.conf'
	local service_config_paths=(
		'/etc/samba'
	)

	# =====================================
	# Simple Actions

	if test "$action" = 'get-config-paths'; then
		echo-lines "${service_config_paths[@]}"
		return 0
	elif test "$action" = 'get-service-ids'; then
		echo-lines "${service_ids[@]}"
		return 0
	fi

	# =====================================
	# Setup Utility

	# install
	# https://en.opensuse.org/Samba
	# https://docs.fedoraproject.org/en-US/quick-docs/samba/#install_and_enable_samba
	# https://wiki.alpinelinux.org/wiki/Setting_up_a_samba-server
	# https://wiki.archlinux.org/title/samba
	setup-util "${util[@]}" --name='Samba' \
		APK='samba' \
		APT='samba' APT='samba-common-bin' \
		RPM='samba' \
		ZYPPER='samba'

	# stop at uninstall?
	if test "$action" = 'uninstall'; then
		# sudo-helper -- mkdir -p /etc/samba
		# ^ don't wipe this as it is just a configuration directory
		# and we want to persist configuration
		return "$?"
	fi

	# =====================================
	# Setup Service

	# only manage the service if it is supported
	if service-helper --supported; then
		# verify the service was initialised
		if service-helper --exists -- "${service_ids[@]}"; then
			# ensure correct permissions
			sudo-helper -- mkdir -p /etc/samba/credentials/share
			fs-own --sudo --admin --permissions=700 \
				-- /etc/samba/credentials
			fs-own --sudo --admin --permissions=600 \
				-- /etc/samba/credentials/share

			# disable autostart
			service-helper --disable --stop \
				-- "${service_ids[@]}"

			# configure
			if confirm --negative --ppid=$$ -- "Customise $service_title configuration?"; then
				edit --sudo -- "$service_config_file"
			fi

			# verify configuration
			testparm --suppress-prompt

			# adapt firewall
			if command-exists firewall-cmd; then
				sudo-helper -- firewall-cmd --get-active-zones
				sudo-helper -- firewall-cmd --permanent --zone=FedoraWorkstation --add-service=samba
				sudo-helper -- firewall-cmd --reload
			fi
		else
			# headful/headless, no service
			echo-error "$0: $service_title was installed, however the service was not."
			return 1
		fi
	fi
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-samba "$@"
fi
