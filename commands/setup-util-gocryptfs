#!/usr/bin/env bash
# shellcheck disable=SC2164
source "$DOROTHY/sources/strict.bash"

# --paths
if test "${1-}" = '--paths'; then
	echo '/etc/fuse.conf'
	exit
fi

# ensure this command is run via [setup-util]
# for consistent detection, quiet/vebose, force mode, optional mode, etc
if test -z "${SETUP_UTIL-}"; then
	setup-util "$@" CLI='gocryptfs' INSTALLER="${BASH_SOURCE:-"$0"}"
	exit "$?"
fi

# download the release
# https://github.com/rfjakob/gocryptfs/releases
temp_directory="$(
	fs-temp \
		--directory='setup-util-gocryptfs' \
		--directory
)"
github-download \
	--slug='rfjakob/gocryptfs' \
	--release='latest' \
	--asset-filter='_src-deps.tar.gz' \
	--unzip-format='auto' \
	--directory="$temp_directory"

# build from source
chmod +x "$temp_directory/build.bash"
("$temp_directory/build.bash")
# this creates the executable locally, and also inside "$GOPATH1/bin"

# make available to sudo, which is necessary for gocryptfs mounts
sudo mkdir -p '/usr/local/bin'
sudo cp -f "$temp_directory/gocryptfs" '/usr/local/bin/gocryptfs'
sudo chmod +x '/usr/local/bin/gocryptfs'
# XDG is not available to sudo, so don't do XDG
