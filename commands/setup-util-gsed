#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-gsed() (
	# install [gsed] if [sed] is not [gsed]
	if is-mac; then
		setup-util "$@" --name='GNU sed' --cli='gsed' \
			BREW='gnu-sed'
	fi

	# if [sed] is [gsed], then make sure [gsed] is available and working
	if ! command-working gsed; then
		local existing symlink="$XDG_BIN_HOME/gsed"
		existing="$(which sed)"
		if test "$existing" != "$(fs-realpath "$existing")"; then
			# alpine symlinks /bin/sed to /bin/busybox, as sych sed symlinks fail (applet not found)
			# so do a workaround
			cat <<-EOF >"$symlink"
				#!/usr/bin/env bash
				set -Eeuo pipefail
				sed "\$@"
			EOF
			chmod +x "$symlink"
		else
			symlink-helper --existing="$existing" --symlink="$symlink"
		fi
	fi

	# if gsed isn't being found, then you are probably using sudo
	# in which use `sudo-helper --inherit -- gsed` instead of `sudo gsed`
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-gsed "$@"
fi
