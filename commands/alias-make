#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# help
if is-help "$@"; then
	cat <<-EOF >/dev/stderr
		ABOUT:
		Create alias file helper.
		You will be prompted for the alias file path and the target file path.

		First prompt: file path where to put the aliased file.
		Second prompt: the target path you want the alias pointing to.

		Eg. "my/alias/path" pointing to "target/real/file/path."
	EOF
	# if test "$#" -ne 0; then
	# 	echo-style $'\n' --error="ERROR:" $'\n' --red="$(echo-lines -- "$@")" >/dev/stderr
	# fi
	return 22 # Invalid argument
fi

# inputs
path="$(
	ask --required \
		--question="Enter path where you want the macOS alias file to exist." \
		--default="${1-}"
)"
target="$(
	ask --required \
		--question="Enter path where you want the macOS alias file to target." \
		--default="${2-}"
)"

# prepare
targetAbsolute="$(fs-absolute "$target")"
pathAbsolute="$(fs-absolute "$path")"
pathDirectory="$(dirname "$pathAbsolute")"
pathFilename="$(basename "$pathAbsolute")"

# act
if test -d "$targetAbsolute"; then
	type="folder"
elif test -f "$targetAbsolute"; then
	type="file"
else
	stderr echo "Invalid path or unsupported type"
	exit 22 # Invalid argument
fi

if test -f "$pathAbsolute"; then
	rm -rfi "$pathAbsolute"
fi

osascript <<-EOF
	tell application "Finder"
		make new alias to $type (posix file "$targetAbsolute") at (posix file "$pathDirectory")
		set name of result to "$pathFilename"
	end tell
EOF

# make the alias's permissions the same as the target's
chmod "$(stat -f '%p' "$targetAbsolute")" "$pathAbsolute"
#chmod --reference="$targetPath" "$pathAbsolute"
