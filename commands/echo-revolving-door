#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# the `|| test -n` trick is from https://unix.stackexchange.com/a/418067/50703
# and allows trailing lines that do not have a trealing newline to still work
# as is the case with:
# sudo pacman -S --needed --noconfirm --quiet bash-completion |& echo-revolving-door

# see echo-clear-line, and echo-clear-lines for similar commands

queue=0

# timeout will cause read to emit a failure exit code, which causes the while loop to fail, which causes everything to fail
while read -r line || test -n "$line"; do
	while test "$queue" -ne 0; do
		echo-clear-line
		queue=$((queue - 1))
	done
	echo "$line"
	queue=$((queue + 1))
done </dev/stdin

while test "$queue" -ne 0; do
	echo-clear-line
	queue=$((queue - 1))
done
