#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# the `|| test -n` trick is from https://unix.stackexchange.com/a/418067/50703
# and allows trailing lines that do not have a trealing newline to still work
# as is the case with:
# sudo pacman -S --needed --noconfirm --quiet bash-completion |& echo-revolving-door

# see echo-clear-line, and echo-clear-lines for similar commands

# cols is essential, as lines larger than the window will wrap and become two cusor lines
# and we can't have that
cols="$(tput cols)"
queue=0

# timeout will cause read to emit a failure exit code, which causes the while loop to fail, which causes everything to fail
while read -r -n "$cols" line || test -n "$line"; do
	while test "$queue" -ne 0; do
		printf '\e[F\e[J'
		queue=$((queue - 1))
	done
	echo "$line"
	queue=$((queue + 1))
done </dev/stdin

while test "$queue" -ne 0; do
	printf '\e[F\e[J'
	queue=$((queue - 1))
done
