#!/usr/bin/env bash

function setup-util-resilio() (
	source "$DOROTHY/sources/strict.bash"

	# =====================================
	# Arguments

	# help
	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Sets up Resilio Sync.

			USAGE:
			setup-util-resilio [...options]

			OPTIONS:
			--paths
			    If specified, output the paths used by Resilio Sync; useful for restoring backups.

			--service
			    If specified, output the service name.

			--group=<group>
			    Groups to attach the service user to.

			...
			    All other options are forwarded to $(echo-style --code='setup-util').
		EOF
		return 22 # Invalid argument
	}

	# process
	local item action='' groups=() util=()
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--paths') action='paths' ;;
		'--service') action='service' ;;
		'--install') action='install' ;;
		'--uninstall') action='uninstall' ;;
		'--action='*) action="${item#*--action=}" ;;
		'--group='*) groups+=("${item#*--group=}") ;;
		*) util+=("$item") ;;
		esac
	done

	# =====================================
	# Preparation

	local service_name='resilio-sync'
	local service_path="/lib/systemd/system/resilio-sync.service"
	local service_config='/etc/resilio-sync/config.json'
	local service_data_paths=(
		'/etc/resilio-sync/'
		'/var/lib/resilio-sync/'
		"$service_config"
		"$XDG_CONFIG_HOME/resilio-sync"
	)
	local service_all_paths=(
		"${service_data_paths[@]}"
		"$service_path"
	)

	# =====================================
	# Simple Actions

	if test "$action" = 'paths'; then
		echo-lines "${service_all_paths[@]}"
		return 0
	elif test "$action" = 'service'; then
		echo "$service_name"
		return 0
	fi

	# =====================================
	# Setup Utility

	# https://help.resilio.com/hc/en-us/articles/206178924
	# https://help.resilio.com/hc/en-us/articles/204762449-Guide-to-Linux
	# https://help.resilio.com/hc/en-us/articles/206178924-Installing-Sync-package-on-Linux

	# install
	setup-util "${util[@]}" --name='Resilio Sync' \
		APT_KEY='https://linux-packages.resilio.com/resilio-sync/key.asc' \
		APT_REPO='deb [arch={ARCH} signed-by={KEY}] http://linux-packages.resilio.com/resilio-sync/deb resilio-sync non-free' \
		APT='resilio-sync'

	# disable autostart
	service-helper --disable --stop -- resilio-sync

	# configure
	if confirm --negative --ppid=$$ -- "Customise Resilio Sync configuration?"; then
		edit --sudo -- "$resilio_service"
		edit --sudo -- "$resilio_config"
	fi

	# permissions
	local resilio_user resilio_group
	resilio_user="$(
		config-helper --file="$resilio_service" -- \
			--field='User'
	)"
	resilio_group="$(
		config-helper --file="$resilio_service" -- \
			--field='Group'
	)"
	fs-own --optional --user="$resilio_user" --group="$resilio_group" \
		-- "${resilio_data_paths[@]}"

	# --group
	local groups group
	mapfile -t groups < <(get-flag-value group --multi -- "$@")
	for group in "${groups[@]}"; do
		sudo-helper -- gpasswd -a "$resilio_user" "$group"
	done
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-resilio "$@"
fi
