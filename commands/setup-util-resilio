#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-resilio() (
	# check for support
	if ! is-ubuntu; then
		echo-style --error="[$0] is implemented for Ubuntu systems..." >/dev/stderr
		if ! confirm-negative --ppid=$$ -- 'Proceed at your own risk?'; then
			return 1
		fi
	fi

	# =====================================
	# Action

	# https://help.resilio.com/hc/en-us/articles/206178924
	# https://help.resilio.com/hc/en-us/articles/204762449-Guide-to-Linux

	# paths
	local resilio_service='/lib/systemd/system/resilio-sync.service'
	local resilio_config='/etc/resilio-sync/config.json'
	local resilio_data_paths=(
		'/etc/resilio-sync/'
		'/var/lib/resilio-sync/'
		# "$HOME/.config/resilio-sync" - perhaps not necessary, as was commented out
	)
	local resilio_paths=(
		"${resilio_data_paths[@]}"
		"$resilio_service"
	)

	# --paths
	if test "${1-}" = '--paths'; then
		echo-lines -- "${resilio_paths[@]}"
		return 0
	fi

	# install
	setup-util "$@" --name='Resilio Sync' \
		APT_KEY='https://linux-packages.resilio.com/resilio-sync/key.asc' \
		APT_REPO='deb http://linux-packages.resilio.com/resilio-sync/deb resilio-sync non-free' \
		APT='resilio-sync'

	# APT_EVAL="
	# 	echo deb http://linux-packages.resilio.com/resilio-sync/deb resilio-sync non-free | sudo tee /etc/apt/sources.list.d/resilio-sync.list
	# 	fetch http://linux-packages.resilio.com/resilio-sync/key.asc | sudo apt-key add -
	# 	sudo apt-get update
	# 	sudo apt-get install resilio-sync
	# "

	# service
	sudo systemctl disable resilio-sync || :
	sudo systemctl stop resilio-sync || :

	# configure
	if confirm-negative --ppid=$$ -- "Customise Resilio Sync configuration?"; then
		edit --sudo -- "$resilio_service"
		edit --sudo -- "$resilio_config"
	fi

	# permissions
	local resilio_user resilio_group
	resilio_user="$(
		config-helper \
			--file="$resilio_service" -- \
			--field='User'
	)"
	resilio_group="$(
		config-helper \
			--file="$resilio_service" -- \
			--field='Group'
	)"
	fs-own --user="$resilio_user" --group="$resilio_group" -- "${resilio_data_paths[@]}"

	# --group
	local groups group
	mapfile -t groups < <(get-flag-value group --multi -- "$@")
	for group in "${groups[@]}"; do
		sudo gpasswd -a "$resilio_user" "$group"
	done
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-resilio "$@"
fi
