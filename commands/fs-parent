#!/usr/bin/env bash
# shellcheck disable=SC2164,SC2103
source "$DOROTHY/sources/strict.bash"

function fs-parent() (
	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Get the expanded parent path of a path.

			USAGE:
			fs-parent <path>

			WHY:
			[dirname .] outputs [.]
			[dirname ..] outputs [.]
			[dirname <a-symlinked-directory>] outputs [.]
			[dirname "$HOME"] outputs [/Users]
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # Invalid argument
	}

	# process
	local item path=''
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*)
			if test -z "$path"; then
				path="$item"
			else
				help "An unrecognised argument was provided: $item"
			fi
			;;
		esac
	done

	# =====================================
	# Action

	if test -z "$path" -o "$path" = '.'; then
		# handles [fs-parent] and [fs-parent .]
		cd ..
		pwd
	elif test -d "$path"; then
		# handles [fs-parent ..] and [fs-parent ./..]
		cd "$path"
		cd ..
		pwd
	elif test -e "$path"; then
		# handles files, in which case we just want the directory that contains the file
		# not the directory that contains the direcvtory that contains the file
		cd "$(dirname "$path")"
		pwd
	else
		# the path doesn't exist, so just infer it by trimming the basename
		local basename parent
		basename="$(basename "$path")"
		parent="${path%"/$basename"}"
		if test "$parent" != "$path"; then
			echo "$parent"
		else
			cat <<-EOF >/dev/stderr
				$(echo-style --error="ERROR:")
				Unable to determine the parent directory for the non-existent path: $(echo-style --code="$path")
			EOF
			exit 1
		fi
	fi
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	fs-parent "$@"
fi
