#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# =====================================
# Arguments

# help
function help() {
	cat <<-EOF >/dev/stderr
 		USAGE:
 		unziptar [archive file path] [--flags...]

 		FLAGS:
 		Provide [--destination=...] to specify which directory the archive will be extracted to, defaults to the pwd.
 		Provide [--format=...] to manually specify format, for cases where it cannot be determined from the filename.
	EOF
	if test "$#" -ne 0; then
		echo-style $'\n' --error="ERROR:" $'\n' --red="$(echo-lines -- "$@")" >/dev/stderr
	fi
	return 22 # Invalid argument
}

# process
while test "$#" -ne 0; do
	item="$1"
	shift
	case "$item" in
	'--help' | '-h') help ;;
	'--'*) help "An unrecognised flag was provided: $item" ;;
	*) help "An unrecognised argument was provided: $item" ;;
	esac
done

# QUESTION: is the ip always the same?

# options
filename="$(
	ask --required \
		--question="Enter the path of the archive to extract." \
		--default="${1-}"
)"
destination="$(get-flag-value destination -- "$@")" # custom destination
format="$(get-flag-value format -- "$@")"           # zip | tar | original filename, say a URL or so, before archive-file became a tmp file
if test -z "$format"; then
	format="$filename"
fi

# =====================================
# Act

filepath="$(fs-absolute "$filename")"

if test "$format" = 'zip' || [[ "$format" = *".zip" ]]; then
	if test -n "$destination"; then
		unzip "$filepath" -d "$destination"
	else
		unzip "$filepath"
	fi
else
	if test -n "$destination"; then
		mkdir -p "$destination"
		cd "$destination" || exit 1
		tar -xvzf "$filepath"
	else
		tar -xvzf "$filepath"
	fi
fi
