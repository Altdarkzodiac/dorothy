#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/nullglob.bash"

# =====================================
# Checks

# check that an accident has not occured
if ! is-mac; then
	echo-style --notice="[$0] is only intended to be run on macOS systems, skipping." >/dev/stderr
	exit 0
fi

# =====================================
# Action

# environment provides:
# HOMEBREW_ARCH, HOMEBREW_PREFIX

# prepare
removals=(
	"${NVM_DIR-}"
	"$HOME/.nvm"
	"${HOMEBREW_PREFIX}/"*
	/usr/local/*
	/opt/homebrew/*
)

# log
echo-segment --h1='Uninstall Homebrew'

# reconfigure shells for the lack of brew, by trimming the brew shells
grep -v "$HOMEBREW_PREFIX" /etc/shells | sudo sponge /etc/shells

# set the default shell to a non-brew shell
if command-exists /bin/zsh; then
	select-shell /bin/zsh
elif command-exists /bin/bash; then
	select-shell /bin/bash
elif command-exists /bin/sh; then
	select-shell /bin/sh
fi

# reset anything that depends on brew
setup-dns system || :
setup-git || :

# uninstall brew
if is-brew; then
	arch -"${HOMEBREW_ARCH}" /bin/bash -c "$(fetch https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)" -- --force
fi

# remove any leftover directories
for remove in "${removals[@]}"; do
	if test -n "$remove" -a -e "$remove"; then
		sudo rm -Rf "$remove" || :
	fi
done

# log
echo-segment --g1='Uninstall Homebrew'
echo-style --green+bold='Homebrew uninstalled, ' --red+bold+underline='restart your terminal to avoid errors.'
