#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-plex() (
	# check for support
	if ! is-ubuntu; then
		echo-style --error="[$0] is implemented for Ubuntu systems..." >/dev/stderr
		if ! confirm-negative --ppid=$$ -- 'Proceed at your own risk?'; then
			return 1
		fi
	fi

	# =====================================
	# Action

	# https://support.plex.tv/articles/235974187#enable-repository-updating-for-supported-linux-server-distributions/
	# https://www.plex.tv/media-server-downloads##plex-media-server

	# --paths
	local plex_service plex_data_paths plex_paths
	plex_service='/lib/systemd/system/plexmediaserver.service'
	plex_data_paths=(
		'/var/lib/plexmediaserver/'
	)
	plex_paths=(
		"$plex_service"
		"${plex_data_paths[@]}"
	)
	if test "${1-}" = '--paths'; then
		echo-lines -- "${plex_paths[@]}"
		return 0
	fi

	# install
	setup-util "$@" --name='Plex Media Server' \
		APT='plexmediaserver' \
		APT_KEY='https://downloads.plex.tv/plex-keys/PlexSign.key' \
		APT_REPO='deb [arch={ARCH} signed-by={KEY}] https://downloads.plex.tv/repo/deb public main' \
		CASK='plex-media-server'

	# service
	sudo-helper -- systemctl disable plexmediaserver || :
	sudo-helper -- systemctl stop plexmediaserver || :

	# configure
	if confirm-negative --ppid=$$ -- "Customise Plex Media Server configuration?"; then
		edit --sudo -- "$plex_service"
	fi

	# permissions
	local plex_user plex_group
	plex_user="$(
		config-helper \
			--file="$plex_service" -- \
			--field='User'
	)"
	plex_group="$(
		config-helper \
			--file="$plex_service" -- \
			--field='Group'
	)"
	fs-own --user="$plex_user" --group="$plex_group" -- "${plex_data_paths[@]}"

	# --group
	local groups group
	mapfile -t groups < <(get-flag-value group --multi -- "$@")
	for group in "${groups[@]}"; do
		sudo-helper -- gpasswd -a "$plex_user" "$group"
	done
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-plex "$@"
fi
