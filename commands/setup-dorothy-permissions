#!/usr/bin/env bash
# shellcheck disable=SC2164
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/globstar.bash"
source "$DOROTHY/sources/nullglob.bash"
source "$DOROTHY/sources/arrays.bash"
requires_array_support 'mapfile'
source "$(which eval-collapse)"

# prepare
cd "$DOROTHY"
mapfile -t directories < <(find-directories)

function correct_permissions() {
	# directories, files that are commands, must be executable
	commands=(
		"$DOROTHY/commands/"*
		"$DOROTHY/user/commands/"*
		"$DOROTHY/user/commands.local/"*
	)
	fs-own --changes --no-recursive --permissions='+rwx' -- "${directories[@]}" "${commands[@]}"
}
eval_collapse \
	--pending="$(echo-style --bold="Correcting permissions...")" \
	--success="$(echo-style --success="Corrected permissions.")" \
	--failure="$(echo-style --error="Failed to correct permissions.")" \
	-- correct_permissions

function stage_new_files() {
	# The following paths are ignored by one of your .gitignore files: ...
	# hint: Use -f if you really want to add them.
	# hint: Turn this message off by running
	# hint: "git config advice.addIgnoredFile false"
	git add --ignore-errors "$DOROTHY"/** || :
}
eval_collapse \
	--pending="$(echo-style --bold="Staging new files...")" \
	--success="$(echo-style --success="Staged new files.")" \
	--failure="$(echo-style --error="Failed to stage new files.")" \
	-- stage_new_files

function stage_changed_files() {
	git add -u || :
}
eval_collapse \
	--pending="$(echo-style --bold="Staging changed files...")" \
	--success="$(echo-style --success="Staged changed files.")" \
	--failure="$(echo-style --error="Failed to stage changed files.")" \
	-- stage_changed_files

eval_collapse \
	--pending="$(echo-style --bold="Removing junk files...")" \
	--success="$(echo-style --success="Removed junk files.")" \
	--failure="$(echo-style --error="Failed to remove junk files.")" \
	-- rm-junk
