#!/usr/bin/env bash

function fs-realpath() (
	source "$DOROTHY/sources/strict.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Output the absolute (relative paths are expanded) and real (symlinks are resolved) respresentation of a path.

			USAGE:
			fs-realpath [--] ...<path>

			QUIRKS:
			Use [fs-absolute] if you do not want symlinks resolved.
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # Invalid argument
	}

	# options
	local item paths=()
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--')
			paths+=("$@")
			shift $#
			break
			;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) paths+=("$item") ;;
		esac
	done

	# check
	if test "${#paths[@]}" -eq 0; then
		help "No <paths> were provided."
	fi

	# =====================================
	# Action

	function fish_capable {
		ommand-exists fish
		# trunk-ignore(shellcheck/SC2016)
		test "$(version-compare "$(fish -c 'echo $FISH_VERSION')" 3.3.0)" -ge 0
	}

	local path
	for path in "${paths[@]}"; do
		if test ! -e "$path"; then
			echo-error "$0: Missing: $path"
			return 2 # ENOENT 2 No such file or directory
		elif test ! -L "$path"; then
			echo "$path" # is not a symlink
		elif command-exists readlink; then
			readlink "$path" # readlink is more reliable on symlinks that have failed targets
		elif command-exists realpath; then
			realpath "$path" # doesn't work for symlinks with failed targets
		elif fish_capable; then
			# https://gitter.im/fish-shell/fish-shell?at=60e4d29c9cf317173013b830
			# not supported in fish v3.1.2
			# supported in fish version v3.3.0
			# exact compatibility unknown
			# if you are using an old version, remove fish and reinstall using [setup-util-fish]
			# trunk-ignore(shellcheck/SC2016)
			fish -c 'realpath "$argv[1]"' -- "$path"
		else
			setup-util-coreutils --quiet
			realpath "$path"
		fi
	done
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	fs-realpath "$@"
fi
