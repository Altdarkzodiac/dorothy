#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# =====================================
# Arguments

# help
function help() {
	cat <<-EOF >/dev/stderr
		ABOUT:
		Remove various caches throughout a macOS developer environment.

		USAGE:
		setup-mac-clean
	EOF
	if test "$#" -ne 0; then
		echo-style $'\n' --error="ERROR:" $'\n' --red="$(echo-lines -- "$@")" >/dev/stderr
	fi
	return 22 # Invalid argument
}

# process
while test "$#" -ne 0; do
	item="$1"
	shift
	case "$item" in
	'help' | '--help' | '-h') help ;;
	'--'*) help "An unrecognised flag was provided: $item" ;;
	*) help "An unrecognised argument was provided: $item" ;;
	esac
done

# check
if ! is-mac; then
	help "This command is only purposeful on macOS, which you are not running."
fi

# =====================================
# Action

# log
echo-segment --h1='Clean macOS'

# Clean brew
setup-mac-brew clean

# Remove updates that are not cleaned automatically
echo-segment --h2='Cleaning application update caches'
list=(
	"$HOME/Library/Application Support/Plex Media Server/Updates"
	"$HOME/Library/Application Support/Spotify/PersistentCache/Update"
)
rm -Rf "${list[@]}"
echo-segment --g2='Cleaned application update caches'

# Remove cache
echo-segment --h2='Cleaning caches'
# rm the removable caches
rm -Rf "$XDG_CACHE_HOME"
# recreate essential directories
list=(
	"$XDG_CACHE_HOME"
	# gems, @todo is this still necessary?
	"$XDG_CACHE_HOME/gems"
	# pip, @todo is this still necessary?
	"$XDG_CACHE_HOME/pip/http"
	"$HOME/Library/Caches/pip/http"
)
mkdir -p "${list[@]}"
echo-segment --g2='Cleaned caches'

# npm
if command-exists npm; then
	{
		echo-segment --h2='Cleaning npm caches'
		source "$DOROTHY/sources/nvm.sh"
		{
			# use `|| :`` as nvm is a function
			nvm use node || :
			npm cache clean --force || :
			nvm use system || :
			npm cache clean --force || :
			nvm use default || :
			npm cache clean --force || :
		} &>/dev/null
		echo-segment --g2='Cleaned npm caches'
	} || {
		echo-segment --e2='Cleaned npm caches'
	}
fi

# done
echo-segment --g1='Clean macOS'
