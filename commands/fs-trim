#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# dependencies
env QUIET=yes setup-util-dust

# prepare
prompt_remove='yes'
if test "${1-}" = '--no-remove'; then
	prompt_remove='no'
fi
path="$1"
path_absolute="$(fs-absolute "$path")"
conclusion=''

# helper
function fs_trim() {
	# is the path missing
	if test ! -e "$path"; then
		conclusion="$(
			echo-style --green="was previously removed."
		)"
		return
	fi
	# path exists

	# note its size
	find "$path" -empty -type d -delete || :
	if test ! -e "$path"; then
		conclusion="$(
			echo-style --green="was only empty directories, it has been removed."
		)"
		return
	fi

	# leftovers
	echo
	echo-eval ls -la "$path"
	echo
	echo-eval dust --no-percent-bars "$path"
	echo
	echo-eval dust --no-percent-bars --filecount "$path"
	echo
	if test "$prompt_remove" = 'yes' && confirm-positive "$(
		echo-style --notice="Confirm removal of non-empty" --bold=" $path_absolute " --notice="?"
	)"; then
		rm -Rfv "$path" || : # may or may not remove
	fi
	if test -e "$path"; then
		conclusion="$(
			echo-style --red="has non-empty files, it has been kept."
		)"
		return 66 # Directory not empty
	fi
	conclusion="$(
		echo-style --green="had non-empty files, it was manually removed."
	)"
}

# act
title="fs-trim ${path@Q}"
echo-segment --h2="$title"
if fs_trim; then
	echo-segment --g2="$title" " $conclusion"
else
	echo-segment --e2="$title" " $conclusion"
fi
