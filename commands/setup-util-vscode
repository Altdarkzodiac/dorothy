#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

function setup-util-vscode() (
	if is-linux; then
		# https://docs.microsoft.com/en-us/visualstudio/liveshare/reference/linux#install-linux-prerequisites
		setup-util "$@" --name='VSCode Linux Dependencies' \
			INSTALLER='https://aka.ms/vsls-linux-prereq-script'
	fi

	setup-util "$@" --name='Visual Studio Code' --cli=code \
		AUR='visual-studio-code-bin' \
		CASK='visual-studio-code' \
		FLATPAK='com.visualstudio.code' \
		NIX='vscode' \
		SNAP='code --classic' \
		-- aur cask flatpak nix snap

	# flatpak does not get access to fonts, nor liveshare dependencies

	# flatpak als does not expose `code` executable, so we have to make it
	# https://unix.stackexchange.com/a/675597/50703
	if command-exists flatpak && flatpak info com.visualstudio.code &> /dev/null; then
		cat <<-EOF >"$XDG_BIN_HOME/code"
			#!/usr/bin/env bash
			flatpak run com.visualstudio.code "\$@"
		EOF
		chmod +x "$XDG_BIN_HOME/code"
	fi
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup-util-vscode "$@"
fi
