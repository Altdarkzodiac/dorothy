#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
# we can assume [HOMEBREW_ARCH, HOMEBREW_PREFIX] have already been provided on brew supported systems

# This is an internal command, no need for help handling.

# Without this command, using HOMEBREW_ARCH=x86_64 on Apple Silicon will fail with:
# ```
# Error: Cannot install in Homebrew on ARM processor in Intel default prefix (/usr/local)!
# Please create a new installation in /opt/homebrew using one of the
# "Alternative Installs" from:
#   https://docs.brew.sh/Installation
# You can migrate your previously installed formula list with:
#   brew bundle dump
# brew on desired architecture
# ```

function brew() (
	if test -x "${HOMEBREW_PREFIX-}/bin/brew"; then
		# as we handle brew updating specially and thoroughly, stop brew from doing it on things like installs
		env HOMEBREW_NO_AUTO_UPDATE=1 \
			arch "-${HOMEBREW_ARCH}" "${HOMEBREW_PREFIX}/bin/brew" "$@"
	else
		echo-style --error='Homebrew is not installed.' ' ' --notice="Install it with:" ' ' --code="$(get-installer brew)" >/dev/stderr
		return 74 # EPROGUNAVAIL 74 RPC prog. not avail
	fi
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	brew "$@"
fi
