#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# help
if is-help "$@"; then
	cat <<-EOF >/dev/stderr
		ABOUT:
		Prompts for path of alias to be converted into a symlink.
	EOF
	return 22 # Invalid argument
fi

# inputs
path="$(
	ask --required \
		--question="Enter the path of the macOS alias file that you want converted into a symlink." \
		--default="${1-}"
)"
# @todo if path is a directory, then replace all aliases inside the directory

# verify alias
src="$(alias-verify "$path" || :)"
if test -z "$src"; then
	stderr echo-style --bold+red="$path" ' ' --error='<- not an alias'
	exit 1
fi

# verify target
target="$(alias-target "$path" || :)"
if test -z "$target"; then
	stderr echo-style --bold="$src" --dim=' → ' --bold+red="$target" ' ' --error='← target broken'
	exit 1
fi
if test ! -e "$target"; then
	stderr echo-style --bold="$src" --dim=' → ' --bold+red="$target" ' ' --error='← target missing'
	exit 1
fi

# convert
if test -f "$target"; then
	ln -nfs "$target" "$src"
	echo "converted $path -> $target"
elif test -d "$target"; then
	ln -nfs "$target" "$src"
	echo "converted $path -> $target"
fi
