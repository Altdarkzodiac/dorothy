#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/nullglob.bash"

# =====================================
# Arguments

# help
function help() {
	cat <<-EOF >/dev/stderr
		ABOUT:
		For common applications, expose their binaries to PATH through $(echo-style --code="$XDG_BIN_HOME") by symlinks or downloads.

		USAGE:
		setup-bin
	EOF
	if test "$#" -ne 0; then
		echo-style $'\n' --error="ERROR:" $'\n' --red="$(echo-lines -- "$@")" >/dev/stderr
	fi
	return 22 # Invalid argument
}

# process
while test "$#" -ne 0; do
	item="$1"
	shift
	case "$item" in
	'help' | '--help' | '-h') help ;;
	'--'*) help "An unrecognised flag was provided: $item" ;;
	*) help "An unrecognised argument was provided: $item" ;;
	esac
done

# =====================================
# Helpers

# prepare
echo-segment --h1='Setup Binaries'
mkdir -p "$XDG_BIN_HOME"

# symlink_app <app> ...[<existing> <symlink>]
function symlink_app {
	local app path existing symlink
	# get the app
	app="$1"
	shift
	# get the path
	path="$(get-app "$app" || :)"
	if test -n "$path" -a -d "$path"; then
		# create a symlink for each bin
		while test "$#" -ne 0; do
			existing="$path/$1"
			shift
			symlink="$XDG_BIN_HOME/$1"
			shift
			if test -x "$existing"; then
				symlink-helper --existing="$existing" --symlink="$symlink"
			fi
		done
	fi
}

# =====================================
# Binaries

# Recreate ssh-askpass if missing or a symlink
target='/usr/lib/ssh/ssh-askpass'
if test ! -e "$target"; then
	files=(
		# manjaro/gnome
		'/usr/lib/seahorse/ssh-askpass'
		# arch/gnome
		'/usr/lib/ssh/gnome-ssh-askpass3'
		# arch/minimal
		'/usr/lib/ssh/x11-ssh-askpass'
	)
	file="$(echo-if-executable "${files[@]}" | echo-first)"
	if test -n "$file"; then
		sudo-inherit -- symlink-helper --existing="$file" --symlink="$target"
	fi
fi

# Atom
symlink_app 'Atom.app' \
	'Contents/Resources/app/atom.sh' 'atom' \
	'Contents/Resources/app/apm/bin/apm' 'apm'

# Visual Studio Code - Insiders
symlink_app 'Visual Studio Code - Insiders.app' \
	'Contents/Resources/app/bin/code' 'code'

# Visual Studio Code
symlink_app 'Visual Studio Code.app' \
	'Contents/Resources/app/bin/code' 'code'

# GitHub
symlink_app 'GitHub.app' \
	'Contents/MacOS/github_cli' 'github'

# Tower
symlink_app 'Tower.app' \
	'Contents/MacOS/gittower' 'tower'

# GitFox
symlink_app 'Gitfox.app' \
	'Contents/SharedSupport/bin/gf' 'gf'

# Kaleidoscope
symlink_app 'Kaleidoscope.app' \
	'Contents/Resources/bin/ksdiff' 'ksdiff'

# Git Scan
if command-missing 'git-scan'; then
	down 'https://download.civicrm.org/git-scan/git-scan.phar' --destination="$XDG_BIN_HOME/git-scan"
fi

# Gitell
if command-missing 'gitell'; then
	github-file-download 'deadc0de6/gitell/master/gitell' --destination="$XDG_BIN_HOME/gitell"
fi

# =====================================
# Permissions

fs-own --no-changes --permissions='+x' -- "$XDG_BIN_HOME/"*

# =====================================
# Done

echo-segment --g1='Setup Binaries'
