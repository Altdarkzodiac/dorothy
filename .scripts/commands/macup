#!/usr/bin/env bash
set -e

export action; action="$1"
export src; src="$HOME"
export cloud; cloud="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Apps/macup"
export tmb="$2";
if is_empty_string "$tmb"; then
	tmb="$(tmutil latestbackup)"
	if is_empty_string "$tmb"; then
		echo "time machine backup couldn't be determined automatically, pass it as the second argument"
		exit -1
	fi
fi
export tml; tml="$tmb/System/$HOME"  # System not sure how I abstract the system thing

function backup {
	echo "backup: $1"
	local dir; dir=$(dirname "$1")
	sudo rm -Rf "$cloud/$1"
	mkdir -p "$cloud/$dir"
	cp -fpLRv "$src/$1" "$cloud/$1"
}
function restore {
	echo "restore: $1"
	local dir; dir=$(dirname "$1")
	sudo rm -Rf "$src/$1"
	mkdir -p "$src/$dir"
	# cp -pLRv "$cloud/$1" "$cloud/$1"
	tmutil restore -v "$tml/$1" "$src/$1"
}
function remove {
	echo "remove: $1"
	sudo rm -Rf "$src/$1"
}
function process {
	if is_equal "$action" "backup"; then
		backup "$1"
	elif is_equal "$action" "restore"; then
		restore "$1"
	else
		echo "USAGE: macup <restore|backup>"
		exit -1
	fi
}

# misc
process .gnupg
process .npmrc
process .ssh
process .scripts/env.sh

# 1password
process "Library/Containers/com.agilebits.onepassword-osx"

# bartender
process Library/Preferences/com.surteesstudios.Bartender.plist

# brave
process "Library/Application Support/brave"

# calibre
process Library/Preferences/calibre
process Library/Preferences/net.kovidgoyal.calibre.plist

# contexts
process Library/Preferences/com.contextsformac.Contexts.plist

# devdocs
process "Library/Application Support/DevDocs"

# firefox
process "Library/Application Support/Firefox"

# freedom
process Library/Preferences/com.80pct.FreedomPlatform.plist

# hazeover
process Library/Preferences/com.pointum.hazeover.plist

# apple: itunes
process Library/Preferences/com.apple.iPod.plist
process Library/Preferences/com.apple.iTunes.plist

# kodi
process "Library/Application Support/Kodi"

# opera
process "Library/Application Support/com.operasoftware.Opera"

# plex
process Library/Preferences/com.plexapp.plexmediaserver.plist
process "Library/Application Support/Plex Media Server"

# apple: safari
if confirm "restore safari history?"; then
	process "Library/Safari/History.db"
	process "Library/Safari/History.db-lock"
	process "Library/Safari/History.db-shm"
	process "Library/Safari/History.db-wal"
	process "Library/Safari/HistoryIndex.sk"
fi
if confirm "restore safari preferences?"; then
	process Library/Preferences/com.apple.Safari.plist
fi

# apple: saved searches
process "Library/Saved Searches"

# slack
process "Library/Containers/com.tinyspeck.slackmacgap"

# skype
process "Library/Application Support/Skype"
process Library/Preferences/com.skype.skype.plist

# spotify
process Library/Preferences/com.spotify.client.plist
process "Library/Application Support/Spotify"

# spotifree
process Library/Preferences/de.eneas.Spotifree.plist

# teamviewer
process Library/Preferences/com.teamviewer.teamviewer.preferences.plist

# apple: terminal
process Library/Preferences/com.apple.Terminal.plist

# transmission
process Library/Preferences/org.m0k.transmission.plist
process "Library/Application Support/Transmission"
# process .config/transmission

# typora
process "Library/Application Support/abnerworks.Typora"
process Library/Preferences/abnerworks.Typora.plist

# usage
process "Library/Application Support/com.mediaatelier.Usage"

# vlc
process "Library/Application Support/org.videolan.vlc"
process Library/Preferences/org.videolan.vlc
process Library/Preferences/org.videolan.vlc.plist

# vmware
process "Library/Preferences/VMware Fusion"

# xld
process Library/Preferences/jp.tmkk.XLD.plist

# apple: messages
# http://apple.stackexchange.com/a/173940/15131
if confirm "restore messages?"; then
	remove Library/Caches/com.apple.iChat
	process Library/Preferences/com.apple.imessage.bag.plist
	process Library/Preferences/com.apple.imservice.ids.FaceTime.plist
	process Library/Preferences/com.apple.imservice.ids.iMessage.plist
	process Library/Preferences/com.apple.iChat.AIM.plist
	process Library/Preferences/com.apple.iChat.Jabber.plist
	process Library/Preferences/com.apple.iChat.StatusMessages.plist
	process Library/Preferences/com.apple.iChat.Yahoo.plist
	process Library/Preferences/com.apple.iChat.plist
	process Library/Messages
	process Library/Containers/com.apple.iChat
fi
