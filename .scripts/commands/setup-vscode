#!/usr/bin/env bash
set -e

if ! command_exists code; then
	echo -e "\nVisual Studio Code (code) does not seem to be installed..."
	exit
fi

# Visual Studio Code Customisations
function vscodeinstall {
	for ARG in "$@"; do
		code --install-extension "$ARG"
	done
}

# Install extensions
echo -e "\nInstalling Visual Studio Code extensions..."
vscodeinstall \
	akamud.vscode-caniuse \
	akamud.vscode-theme-onelight \
	christian-kohler.npm-intellisense \
	dbaeumer.vscode-eslint \
	EditorConfig.EditorConfig \
	flowtype.flow-for-vscode \
	PKief.material-icon-theme \
	slb235.vscode-coffeelint \
	TeddyDD.fish \
	timonwong.shellcheck

# Customise
echo -e "\nCustomising Visual Studio Code settings..."

# Customise settings
ln -f "$HOME/.vscode/settings.json" "$HOME/Library/Application Support/Code/User/settings.json"
ln -f "$HOME/.vscode/keybindings.json" "$HOME/Library/Application Support/Code/User/keybindings.json"

# Customise stylesheets
app=$(getapp Visual Studio Code.app)

# https://github.com/Microsoft/vscode/issues/1896#issuecomment-283858289
stylesheet="$app/Contents/Resources/app/out/vs/workbench/electron-browser/workbench.main.css"
if is_file "$stylesheet"; then
	if silent grep 'fix font rendering' < "$stylesheet"; then
		echo "setup already completed"
	else
		echo "
		/* fix font rendering */
		.monaco-editor {
			-webkit-font-smoothing: antialiased !important;
			text-rendering: optimizeLegibility !important;
		}" >> "$stylesheet"
		echo "setup completed"
	fi
else
	echo "vscode not installed"
fi

# https://github.com/akamud/vscode-theme-onelight/pull/2
stylesheet=$(expandpath "$HOME/.vscode/extensions/akamud.vscode-theme-onelight-*/themes/OneLight.tmTheme")
if is_file "$stylesheet"; then
	echo "fixing theme"
	sed -e 's/#FAFAFA/#FFFFFF/' -e 's/#F2F2F2/#F5F5F5/' < "$stylesheet" > "$stylesheet.tmp"
	mv -f "$stylesheet.tmp" "$stylesheet"
	echo "fixed theme"
else
	echo "theme not installed"
fi